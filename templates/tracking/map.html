{% extends "base.html" %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
{% endblock %}

{% block content %}
    <section class="tracking-layout">
        <aside class="tracking-panel">
            <h2>Filters</h2>
            <div class="filter-group" id="status-filter" data-filter-type="status">
                <h3>Status</h3>
                <button type="button" class="filter-button is-active" data-filter="">All</button>
                {% for status in status_filters %}
                    <button type="button" class="filter-button" data-filter="{{ status }}">{{ status }}</button>
                {% endfor %}
            </div>
            <div class="filter-group" id="fleet-filter" data-filter-type="fleet_area">
                <h3>Route</h3>
                <button type="button" class="filter-button is-active" data-filter="">All</button>
                {% for fleet in fleet_filters %}
                    <button type="button" class="filter-button" data-filter="{{ fleet }}">{{ fleet }}</button>
                {% endfor %}
            </div>
            <div class="panel-help">
                <p>Use the controls to highlight vehicles that match a specific status or region. The map and details refresh automatically.</p>
            </div>
            {% if tile_provider_choices %}
                <div class="map-provider-group">
                    <h3>Base Map</h3>
                    <label class="map-provider-label" for="tile-provider-select">Tile source</label>
                    <select id="tile-provider-select">
                        {% for provider in tile_provider_choices %}
                            <option value="{{ provider.key }}"{% if provider.key == default_tile_provider %} selected{% endif %}>{{ provider.label }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            <div class="overlay-group" id="overlay-controls">
                <h3>Overlays</h3>
                <label class="overlay-toggle">
                    <input type="checkbox" data-overlay="geofences" checked>
                    <span>Geofences</span>
                </label>
                <label class="overlay-toggle">
                    <input type="checkbox" data-overlay="depots" checked>
                    <span>Depots</span>
                </label>
                <label class="overlay-toggle">
                    <input type="checkbox" data-overlay="traffic" checked>
                    <span>Traffic</span>
                </label>
            </div>
            <div class="route-finder">
                <h3>Find Route</h3>
                <div>
                    <p>Start: <span id="start-coords">-</span></p>
                    <p>End: <span id="end-coords">-</span></p>
                    <p>Distance: <span id="route-distance">--</span> km</p>
                </div>
                <button id="find-route-btn">Find Route</button>
                <div id="assign-vehicle-controls" hidden>
                    <hr>
                    <label for="idle-vehicle-select">Assign Idle Vehicle:</label>
                    <select id="idle-vehicle-select">
                        <option value="">-- Select Vehicle --</option>
                    </select>
                    <button id="assign-vehicle-btn">Assign</button>
                    <p id="assign-status-msg"></p>
                </div>
            </div>
        </aside>
        <section class="tracking-map-section">
            <div id="map" class="tracking-map" aria-live="polite">
                <div id="map-legend" class="map-legend" aria-hidden="true"></div>
            </div>
            <section class="tracking-details" aria-live="polite">
                <h2>Vehicle Snapshot</h2>
                <p class="tracking-updated" id="last-updated">Last update: {{ generation_time }}</p>
                <p class="tracking-traffic-meta" id="traffic-meta">
                    Traffic source: {{ traffic_source }} &mdash; refreshed {{ traffic_generated }}
                </p>
                <div class="vehicle-search">
                    <label for="vehicle-search-input">Search Vehicles</label>
                    <input
                        type="search"
                        id="vehicle-search-input"
                        name="vehicle-search"
                        placeholder="Search by vehicle, driver, make, model, or license plate"
                        autocomplete="off"
                    >
                </div>
                <div id="vehicle-table" class="tracking-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Driver</th>

                                <th>Status</th>
                                <th>Speed (km/h)</th>
                                <th>Route</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for vehicle in vehicles %}
                            <tr>
                                <td>{{ vehicle.name }}</td>
                                <td>{{ vehicle.identifiers.driver|default:"—" }}</td>

                                <td>{{ vehicle.status }}</td>
                                <td>{{ vehicle.speed_kmh }}</td>
                                <td>{{ vehicle.fleet_area }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="vehicle-detail-card" class="vehicle-detail-card" aria-live="polite">
                    <h3>Driver Details</h3>
                    <p id="vehicle-detail-empty" class="vehicle-detail-empty">
                        Select a vehicle to view driver information.
                    </p>
                    <div id="vehicle-detail-content" class="vehicle-detail-content" hidden>
                        <dl class="vehicle-detail-list">
                            <div>
                                <dt>Driver</dt>
                                <dd id="detail-driver-name">—</dd>
                            </div>
                            <div>
                                <dt>Mobile Number</dt>
                                <dd id="detail-driver-phone">—</dd>
                            </div>
                            <div>
                                <dt>License Number</dt>
                                <dd id="detail-driver-license">—</dd>
                            </div>
                            <div>
                                <dt>Current Route</dt>
                                <dd id="detail-route-name">—</dd>
                            </div>
                            
                        </dl>
                        <div class="vehicle-route-history">
                            <h4>Route History</h4>
                            <ol id="detail-route-history" class="vehicle-route-history-list">
                                <li class="route-history-empty">No route history available.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>
        </section>
    </section>

    <script type="application/json" id="initial-vehicle-data">{{ vehicles_json|safe }}</script>
    <script type="application/json" id="initial-map-center">{{ center_json|safe }}</script>
    <script type="application/json" id="initial-generation-time">{{ generation_time_json|safe }}</script>
    <script type="application/json" id="initial-geofences">{{ geofences_json|safe }}</script>
    <script type="application/json" id="initial-depots">{{ depots_json|safe }}</script>
    <script type="application/json" id="initial-route-catalog">{{ route_catalog_json|safe }}</script>
    <script type="application/json" id="initial-map-legend">{{ legend_json|safe }}</script>
    <script type="application/json" id="initial-traffic-overlay">{{ traffic_features_json|safe }}</script>
    <script type="application/json" id="initial-traffic-meta">{{ traffic_meta_json|safe }}</script>
    <script type="application/json" id="map-tiles-config">{{ map_tiles_config_json|safe }}</script>
{% endblock %}

{% block body_scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="{% static 'tracking/js/map.js' %}"></script>
{% endblock %}
